<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        >
        <title>Natal da Sorte - Sorteio Online</title>
        <!-- CSS Consolidado -->
        <link rel="stylesheet" href="/css/painel.css?v=3">
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    </head>
    <body>
        <!-- Barra de navegaÃ§Ã£o -->
        <header class="ns-navbar">
            <div class="ns-nav-inner">
                <div class="ns-brand">
                    <span class="logo">ğŸ‘¤</span>
                    <span id="menu-brand-name">UsuÃ¡rio</span>
                    <!-- Bolinha de status -->
                    <span
                        id="user-status"
                        style="
              display: inline-block;
              width: 14px;
              height: 14px;
              border-radius: 50%;
              background-color: gray;
              margin-left: 8px;
              vertical-align: middle;
            "
                    ></span>
                    <span
                        id="status-text"
                        style="font-size: 0.85rem; margin-left: 4px; vertical-align: middle"
                    >
                        Offline
                    </span>
                </div>
                <div class="ns-actions">
                    <button
                        id="logout-btn"
                        class="ns-logout"
                    >
                        Sair
                    </button>
                </div>
            </div>
        </header>



        <div
            class="snowflakes"
            id="snowflakes"
        ></div>



        <!-- Popup de regras do sorteio -->
        <div id="rules-modal">
            <div class="rules-card">
                <div class="rules-header">
                    <span class="rules-icon">âš ï¸</span>
                    <div>
                        <h3>Regras do Sorteio</h3>
                        <p>Leia atentamente antes de participar</p>
                    </div>
                </div>
                <div class="rules-body">
                    <ul>
                        <li>
                            Assista ao vÃ­deo para liberar seus nÃºmeros da sorte.
                        </li>
                        <li>Guarde seu comprovante de participaÃ§Ã£o.</li>
                        <li>O sorteio Ã© transparente e auditÃ¡vel.</li>
                        <li>
                            NÃºmeros sorteados sÃ£o destacados em tempo real.
                        </li>
                        <li>
                            Ao participar, vocÃª concorda com o regulamento oficial.
                        </li>
                    </ul>
                </div>
                <div class="rules-actions">
                    <button
                        id="rules-accept-btn"
                        class="btn btn-primary"
                    >
                        Estou de acordo
                    </button>
                </div>
            </div>
        </div>



        <div class="container">
            <h1>ğŸ„ Natal da Sorte ğŸ„</h1>
            <p class="subtitle">Sorteio Online Especial de Natal</p>



            <div class="video-section">
                <div class="video-wrapper">
                    <!-- YouTube Player com API habilitada -->
                    <iframe
                        id="youtube-player"
                        width="1236"
                        height="695"
                        src="https://www.youtube.com/embed/J_wknYevNKE?enablejsapi=1&origin=http://localhost:8080"
                        title="Sorteio da promoÃ§Ã£o NATAL DA SORTE"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin"
                        allowfullscreen
                    ></iframe>
                </div>
            </div>



            <div class="timer-section">
                <div class="timer-label">
                    â±ï¸ Assista para liberar seu nÃºmero da sorte
                </div>
                <div
                    class="timer-display"
                    id="timer"
                >
                    00:00
                </div>
                <div
                    class="timer-message"
                    id="timer-message"
                >
                    â–¶ï¸ Inicie o vÃ­deo para iniciar a contagem!
                </div>
            </div>




            <!-- ----sessÃ£o dos numeros sorteados ----------------- -->
            <div class="number-section">
                <button
                    class="number-label"
                    id="generate-btn"
                >
                    ğŸ Gere seus NÃºmeros da Sorte
                </button>
                <div
                    class="number-display locked"
                    id="lucky-number"
                >
                    <span>00</span>
                    <span>00</span>
                    <span>00</span>
                    <span>00</span>
                    <span>00</span>
                    <span>00</span>
                    <span>00</span>
                    <span>00</span>
                    <span>00</span>
                    <span>00</span>
                </div>
            </div>



            <!-- Modal do Ganhador -->
            <div
                id="winner-modal"
                style="
          display: none;
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.9);
          z-index: 9999;
          align-items: center;
          justify-content: center;
        "
            >
                <div style="
            background: linear-gradient(135deg, #c41e3a 0%, #8b1428 100%);
            padding: 50px;
            border-radius: 24px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: bounce 0.6s ease-in-out;
          ">
                    <div style="font-size: 80px; margin-bottom: 20px">ğŸ†</div>
                    <h2 style="
              color: #fbbf24;
              font-size: 48px;
              margin-bottom: 15px;
              text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            ">PARABÃ‰NS!</h2>
                    <p style="
              color: white;
              font-size: 24px;
              font-weight: 700;
              margin-bottom: 30px;
            ">VOCÃŠ Ã‰ O GANHADOR!</p>
                    <p style="color: rgba(255, 255, 255, 0.9); font-size: 18px">Todos os seus nÃºmeros foram sorteados!</p>
                </div>
            </div>



            <div class="info-section">
                <div class="info-card">
                    <div class="info-icon">ğŸ¯</div>
                    <h4>Sorteio ao Vivo</h4>
                    <p>Acompanhe em tempo real pelo YouTube</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">ğŸ</div>
                    <h4>PrÃªmios IncrÃ­veis</h4>
                    <p>
                        VocÃª concorre atÃ© 20 mil reais em prÃªmios
                    </p>
                </div>
                <div class="info-card">
                    <div class="info-icon">âœ¨</div>
                    <h4>100% Transparente</h4>
                    <p>Sorteio justo e verificÃ¡vel</p>
                </div>
            </div>
        </div>



        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ğŸ„ Natal da Sorte</h3>
                    <p>
                        Celebrando o espÃ­rito natalino com muita alegria e prÃªmios!
                    </p>
                </div>



                <div class="footer-section">
                    <h4>Contato</h4>
                    <p>ğŸ“§ falazÃ©@gmail.com</p>
                    <p>ğŸ“± WhatsApp: (75) 9 8131-2855</p>
                </div>



                <div class="footer-section">
                    <h4>Redes Sociais</h4>
                    <div class="social-links">
                        <a
                            href="#"
                            class="social-link"
                        >
                            ğŸ“˜ Facebook
                        </a>
                        <a
                            href="#"
                            class="social-link"
                        >
                            ğŸ“¸ Instagram
                        </a>
                        <a
                            href="#"
                            class="social-link"
                        >
                            ğŸ¥ YouTube
                        </a>
                    </div>
                </div>
            </div>



            <div class="footer-bottom">
                <p>
                    &copy; ZÃ© Roberto Propaganda - Todos os direitos reservados
                </p>
                <p class="footer-disclaimer">
                    âš ï¸ PromoÃ§Ã£o vÃ¡lida conforme regulamento. Participe de forma
          consciente.
                </p>
            </div>
        </footer>



        <!-- JavaScript -->
        <script src="/js/utils.js"></script>
        <script src="/js/auth.js"></script>
        <script src="/js/script.js"></script>
        <script>
            let loggedUserEmail = null;

  async function loadUserInfo() {
    try {
      const response = await fetch("/api/user");

      if (!response.ok) {
        throw new Error("UsuÃ¡rio nÃ£o autenticado");
      }

      const user = await response.json();

      // Preenche nome no header
      document.getElementById("menu-brand-name").textContent = user.name;

      // Guarda email para WebSocket
      loggedUserEmail = user.email;

      // Agora sim conecta no WebSocket
      connectWebSocket();

    } catch (error) {
      console.error("Erro ao carregar usuÃ¡rio:", error);
      window.location.href = "/login.html";
    }
  }

  function connectWebSocket() {
    const statusIndicator = document.getElementById("user-status");
    const statusText = document.getElementById("status-text");

    const socket = new SockJS("/ws");
    const stompClient = Stomp.over(socket);

    stompClient.connect(
      {},
      () => {
        console.log("Conectado ao WebSocket");

        fetch(`/api/user-online?email=${loggedUserEmail}`);

        stompClient.subscribe("/topic/online-status", (msg) => {
          const onlineUsers = JSON.parse(msg.body);
          const online = onlineUsers.includes(loggedUserEmail);

          if (online) {
            statusIndicator.style.backgroundColor = "green";
            statusText.textContent = "Online";
          } else {
            statusIndicator.style.backgroundColor = "red";
            statusText.textContent = "Offline";
          }
        });
      },
      (error) => {
        console.warn("ConexÃ£o perdida:", error);
        statusIndicator.style.backgroundColor = "red";
        statusText.textContent = "Offline";
      }
    );

    // Marca offline ao sair
    window.addEventListener("beforeunload", () => {
      navigator.sendBeacon(
        `/api/user-offline?email=${loggedUserEmail}`
      );
    });
  }

  // ğŸš€ inicia tudo
  document.addEventListener("DOMContentLoaded", loadUserInfo);
        </script>



    </body>
</html>
